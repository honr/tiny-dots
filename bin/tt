#!/bin/zsh

# Requires the utility ws.dirs in the PATH.

# Convenience command for tmux project management.
# When creating a session, the initial directory is looked up in ~/.tmux/DIRS.
# Then the project-specific script at ~/.tmux/$STY is sourced if existing.
main() {
  if [[ -z "$1" ]] ; then
    tmux list-sessions
    return
  fi
  local sty="$1"
  if tmux attach-session -t "$sty" ; then
    return
  fi

  local dir="$(ws.dirs $sty | head -n 1)"
  tmux new-session -d -s "$sty" -c "$dir" env STY="$sty" "$SHELL"
  tmux set-environment -t "$sty" STY "$sty"
  if [[ -e "$HOME/.tmux/$sty" ]] ; then
    "$HOME/.tmux/$sty"
  fi
  tmux attach-session -t "$sty"
}

main "$@"
